# file opened: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\mannin.asm
  1   0000                      DEVICE ZXSPECTRUM48
  2   0000              	    SLDOPT COMMENT WPMEM, LOGPOINT, ASSETION
  3   0000                      ORG $8000               ; Programa ubicado a partir de $8000 = 32768
  4   8000
  5   8000 F3           inicio:     DI              ; Deshabilitar interrupciones
  6   8001 31 00 00                 LD SP,0         ; Establecer el puntero de pila en la parte alta de la memoria
  7   8004
  8   8004              ;-------------------------------------------------------------------------------------------------
  9   8004              ;Código del estudiante
 10   8004
 11   8004                  INCLUDE "bienvenida.asm"  ; Incluir el código de bienvenida
# file opened: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\bienvenida.asm
  1+  8004              ; Rutina de bienvenida para el juego Conecta 4
  2+  8004              ; Se incluye desde el programa principal
  3+  8004              Bienvenida:
  4+  8004 3E 00            LD A, 0
  5+  8006 D3 FE            OUT ($FE),A     ; Poner el borde de la pantalla negro
  6+  8008 CD E1 81         CALL CLEARSCR   ; Borrar pantalla
  7+  800B
  8+  800B 3E 82            LD A,2+$80      ; Letra roja, fondo negro, parpadeante
  9+  800D 06 01            LD B,1          ; Coordenadas para pintar el título
 10+  800F 0E 04            LD C,4
 11+  8011 DD 21 B9 80      LD IX,Titulo    ; Dirección del título
 12+  8015 CD 70 81         CALL PRINTAT    ; Imprime el título
 13+  8018
 14+  8018 3E 03            LD A,3          ; Letra moradito Vegetta, fondo negro
 15+  801A 06 14            LD B,20         ; Coordenadas para pintar el mensaje
 16+  801C 0E 01            LD C,1
 17+  801E DD 21 D1 80      LD IX,Mensaje   ; Dirección del mensaje
 18+  8022 CD 70 81         CALL PRINTAT    ; Imprime el mensaje
 19+  8025
 20+  8025 06 14            LD B,20         ; Buscamos la dirección del atributo de coordenadas 20,30
 21+  8027 0E 1E            LD C,30         ; Para poner el cursor
 22+  8029 CD 76 80         CALL Coor_Atrib ; Esta rutina devuelve en HL la dirección del atributo
 23+  802C 3E 81            LD A,1+$80      ; Azul parpadeante
 24+  802E 77               LD (HL),A       ; Pongo el atributo
 25+  802F
 26+  802F CD 93 80         CALL Teclado    ; Leo el teclado hasta que pulsen S o N
 27+  8032
 28+  8032 3E 01            LD A,1          ; Eco de la tecla pulsada
 29+  8034 06 14            LD B,20
 30+  8036 0E 1E            LD C,30
 31+  8038 DD 21 00 81      LD IX,Caracter
 32+  803C CD 70 81         CALL PRINTAT
 33+  803F
 34+  803F 3E 07            LD A,7          ; Letra azul, fondo negro
 35+  8041 06 12            LD B,18         ; Coordenadas para pintar el mensaje
 36+  8043 0E 01            LD C,1
 37+  8045 DD 21 EF 80      LD IX,Respuesta   ; Dirección del mensaje
 38+  8049 CD 70 81         CALL PRINTAT    ; Imprime el mensaje
 39+  804C 3E 04            LD A,4
 40+  804E 06 12            LD B,18
 41+  8050 0E 11            LD C,17
 42+  8052 DD 21 00 81      LD IX,Caracter
 43+  8056 CD 70 81         CALL PRINTAT
 44+  8059
 45+  8059                  ; Comprobar si se pulsó 'N'
 46+  8059 3A 00 81         LD A,(Caracter)
 47+  805C FE 4E            CP 'N'
 48+  805E 20 10            JR NZ, fin_bienvenida   ; Si no es 'N', salir
 49+  8060
 50+  8060                  ; Si es 'N', mostrar mensaje de despedida
 51+  8060 3E 04            LD A,4          ; Color rojo
 52+  8062 06 0A            LD B,10        ; Fila 20
 53+  8064 0E 01            LD C,1          ; Columna 1
 54+  8066
 55+  8066 DD 21 02 81      LD IX,Adios     ; Mensaje de despedida
 56+  806A CD 70 81         CALL PRINTAT    ; Mostrar mensaje
 57+  806D C3 00 00         JP 0            ; Volver al BASIC (cierra el programa)
 58+  8070
 59+  8070              fin_bienvenida:
 60+  8070 CD E1 81         CALL CLEARSCR   ; Borrar pantalla
 61+  8073 CD 1C 81         CALL Despedida    ; Retornar al programa principal para seguir las siguientes rutinas
 62+  8076
 63+  8076              Coor_Atrib:
 64+  8076                                      ; Rutina que recibe en B,C las coordenadas de la pantalla (fila, columna)
 65+  8076                                      ; y devuelve en HL la dirección del atributo correspondiente
 66+  8076 F5               PUSH AF             ; Guardamos A en el stack
 67+  8077 C5               PUSH BC             ; Guardamos BC en el stack
 68+  8078 60               LD H,b              ; Los bits 4,5 de B deben ser los bits 0,1 de H
 69+  8079 CB 3C            SRL H
 69+  807B CB 3C          SRL H
 69+  807D CB 3C          SRL H
 70+  807F 78               LD A,B              ; Los bits 0,1,2 de B deben ser los bits 5,6,7 de L
 71+  8080 CB 27            SLA A
 71+  8082 CB 27          SLA A
 71+  8084 CB 27          SLA A
 71+  8086 CB 27          SLA A
 71+  8088 CB 27          SLA a
 72+  808A B1               OR c                ; Y C son los bits 0-4 de L
 73+  808B 6F               LD L,A
 74+  808C 01 00 58         LD BC, $5800        ; Le sumamos la dirección de comienzo de los atributos
 75+  808F 09               ADD HL,BC
 76+  8090 C1               POP BC              ; Restauramos los valores del stack
 77+  8091 F1               POP AF
 78+  8092 C9               RET
 79+  8093
 80+  8093              Teclado:                ; Rutina para leer del teclado 'S' o 'N'
 81+  8093 C5               PUSH BC             ; BC al stack para preservar su valor
 82+  8094              T_N:
 83+  8094 01 FE 7F         LD BC,$7FFE         ; Escanear línea B,N,M,SYMB,Space
 84+  8097 ED 78            IN A,(C)
 85+  8099 CB 5F            BIT 3,A
 86+  809B 20 04            JR NZ,T_S           ; Han pulsado N
 87+  809D 3E 4E            LD A,'N'
 88+  809F
 89+  809F 18 0B            JR T_F
 90+  80A1              T_S:
 91+  80A1 01 FE FD         LD BC,$FDFE         ; Escanear línea G,F,D,S,A
 92+  80A4 ED 78            IN A,(C)
 93+  80A6 CB 4F            BIT 1,A
 94+  80A8 20 EA            JR NZ,T_N           ; No han pulsado 'S'
 95+  80AA 3E 53            LD A,'S'
 96+  80AC              T_F:
 97+  80AC 32 00 81         LD (Caracter),A     ; Guardo 'S' o 'N' en la Variable Caracter
 98+  80AF              Soltar_Tecla:           ; Rutina de espera hasta que se suelta la tecla
 99+  80AF ED 78            IN A,(C)            ; Leer del puerto que se ha definido en Lee_Tecla
100+  80B1 E6 1F            AND $1F
101+  80B3 FE 1F            CP $1F              ; Comprobar que no hay tecla pulsada
102+  80B5 20 F8            JR NZ,Soltar_Tecla  ; esperar hasta que no haya tecla pulsada
103+  80B7 C1               POP BC              ; Recuperamos el valor de BC
104+  80B8 C9               RET
105+  80B9
106+  80B9 42 69 65 6E  Titulo:    db "Bienvenido al Conecta 4",0    ; Título
106+  80BD 76 65 6E 69
106+  80C1 64 6F 20 61
106+  80C5 6C 20 43 6F
106+  80C9 6E 65 63 74
106+  80CD 61 20 34 00
107+  80D1 45 6D 70 65  Mensaje:   db "Empezamos una partida (S/N)? ",0   ; Mensaje inicial
107+  80D5 7A 61 6D 6F
107+  80D9 73 20 75 6E
107+  80DD 61 20 70 61
107+  80E1 72 74 69 64
107+  80E5 61 20 28 53
107+  80E9 2F 4E 29 3F
107+  80ED 20 00
108+  80EF 48 61 73 20  Respuesta: db "Has contestado: ",0      ; Mensaje con la respuesta
108+  80F3 63 6F 6E 74
108+  80F7 65 73 74 61
108+  80FB 64 6F 3A 20
108+  80FF 00
109+  8100 00 00        Caracter:  db 0,0              ; Mensaje del carácter para imprimir
110+  8102 47 72 61 63  Adios:     db "Gracias por jugar. Adios!",0 ; Mensaje de despedida
110+  8106 69 61 73 20
110+  810A 70 6F 72 20
110+  810E 6A 75 67 61
110+  8112 72 2E 20 41
110+  8116 64 69 6F 73
110+  811A 21 00
111+  811C
# file closed: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\bienvenida.asm
 12   811C                  INCLUDE "pantalla_final.asm" ; Incluir el código de despedida
# file opened: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\pantalla_final.asm
  1+  811C              ; Rutina de despedida para el juego Conecta 4
  2+  811C              ; Se incluye desde el programa principal
  3+  811C
  4+  811C              Despedida:
  5+  811C 3E 00            LD A, 0
  6+  811E D3 FE            OUT ($FE),A     ; Poner el borde de la pantalla negro
  7+  8120
  8+  8120 3E 83            LD A,3+$80      ; Letra moradita, fondo negro, parpadeante
  9+  8122 06 01            LD B,1          ; Coordenadas para pintar el título
 10+  8124 0E 04            LD C,4
 11+  8126 DD 21 3A 81      LD IX,Titulo_final    ; Dirección del título
 12+  812A CD 70 81         CALL PRINTAT    ; Imprime el título
 13+  812D
 14+  812D 3E 0D            LD A,13          ; Letra azulita, fondo negro
 15+  812F 06 14            LD B,20       ; Coordenadas para pintar el mensaje
 16+  8131 0E 01            LD C,1
 17+  8133 DD 21 51 81      LD IX,Mensaje_final   ; Dirección del mensaje
 18+  8137 CD 70 81         CALL PRINTAT    ; Imprime el mensaje
 19+  813A
 20+  813A 50 61 72 74  Titulo_final:    db "Partida epiquisima bro",0    ; Título
 20+  813E 69 64 61 20
 20+  8142 65 70 69 71
 20+  8146 75 69 73 69
 20+  814A 6D 61 20 62
 20+  814E 72 6F 00
 21+  8151 51 75 69 65  Mensaje_final:   db "Quieres jugar de nuevo (S/N)? ",0   ; Mensaje inicial
 21+  8155 72 65 73 20
 21+  8159 6A 75 67 61
 21+  815D 72 20 64 65
 21+  8161 20 6E 75 65
 21+  8165 76 6F 20 28
 21+  8169 53 2F 4E 29
 21+  816D 3F 20 00
 22+  8170
# file closed: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\pantalla_final.asm
 13   8170                  INCLUDE "printat.asm"         ; Incluir el código de PRINTAT
# file opened: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\printat.asm
  1+  8170              ; -------------------------------
  2+  8170              ; ZX Spectrum Text print library
  3+  8170              ; Daniel León - AOC - UFV 2020
  4+  8170              ; -------------------------------
  5+  8170
  6+  8170
  7+  8170              ; ----------------------------------------------------------------------------------------
  8+  8170              ; PRINTAT - Print a string in a position and attributes as per registers:
  9+  8170              ;		IN	A	: Bit 7=1 For Flash / Bit 6=1 For Brigh / Bit 5,4,3 for Paper / Bit 2,1,0 for Ink
 10+  8170              ;		IN	B	: Row 0..23
 11+  8170              ;		IN	C	: Column 0..31
 12+  8170              ;		IN	IX	: Address of text (Text must end in a 0)
 13+  8170              ; ----------------------------------------------------------------------------------------
 14+  8170 CD 7F 81     PRINTAT:	CALL PREP_PRT				; Update Attribute var &Screen & Attributes pointers
 15+  8173              ; ----------------------------------------------------------------------------------------
 16+  8173              ;		VVV Do not move PRINTSTR below as PRINTAT continues into PRINTSTR routine
 17+  8173              ; ----------------------------------------------------------------------------------------
 18+  8173              ; PRINTSTR - Prints String - IX Points to the String start
 19+  8173              ; ----------------------------------------------------------------------------------------
 20+  8173 DD 7E 00     PRINTSTR:   LD A,(IX)					; A Contains first char to print
 21+  8176 B7           			OR A						; check for end of string (0)
 22+  8177 C8           			RET Z						; Finish printing if 0
 23+  8178 CD AD 81     			CALL PRINTCHNUM
 24+  817B DD 23        			INC IX						; Move to next char in string
 25+  817D 18 F4        			JR PRINTSTR					; Start over printing sequence
 26+  817F              ; ----------------------------------------------------------------------------------------
 27+  817F
 28+  817F
 29+  817F              ;-----------------------------------------------------------------------------------------
 30+  817F              ; PREP_PRT - Updates Print_Attr, SCR & ATTR Vars
 31+  817F              ;-----------------------------------------------------------------------------------------
 32+  817F 32 F3 81     PREP_PRT:	LD (PRINT_ATTR),A			; Set Attribute
 33+  8182 CD 88 81     PREP_PRT_2:	CALL CRtoSCREEN
 34+  8185 C3 9A 81     			JP CRtoATTR
 35+  8188              ;-----------------------------------------------------------------------------------------
 36+  8188
 37+  8188              ;-----------------------------------------------------------------------------------------
 38+  8188              ; CRtoSCREEN - Converts a scr char coord into a SCREEN Address   b,c = y,x positions
 39+  8188              ;	IN  - B=Row, C=Column
 40+  8188              ;	OUT - HL=Address in screen also stored in (SCR_CUR_PTR)
 41+  8188              ;	Conversion:
 42+  8188              ;			Row FFfff   Column CCCCC
 43+  8188              ;			HL=%010FF000 fffCCCCC
 44+  8188              ;-----------------------------------------------------------------------------------------
 45+  8188              CRtoSCREEN:
 46+  8188 78           			LD A,B						; %___FFfff
 47+  8189 F6 40        			OR #40						; %010FFfff
 48+  818B E6 F8        			AND #F8						; %010FF000
 49+  818D 67           			LD H,A
 50+  818E
 51+  818E 78           			LD A,B						; %___FFfff
 52+  818F E6 07        			AND #7						; %00000fff
 53+  8191 0F           			RRCA						; %f00000ff
 54+  8192 0F           			RRCA						; %ff00000f
 55+  8193 0F           			RRCA						; %fff00000
 56+  8194 B1           			OR C						; %fffCCCCC
 57+  8195 6F           			LD L,A
 58+  8196 22 EF 81                 LD (SCR_CUR_PTR),HL			; Update Variable
 59+  8199 C9                       RET
 60+  819A              ; ----------------------------------------------------------------------------------------
 61+  819A
 62+  819A
 63+  819A
 64+  819A              ;-----------------------------------------------------------------------------------------
 65+  819A              ; CRtoATTR - Converts a screen char coord  into a ATTR Address  b,c = y,x positions
 66+  819A              ;	IN  - B=Row, C=Column
 67+  819A              ;	OUT - HL=Address in screen also stored in (SCR_ATTR_PTR)
 68+  819A              ;	Conversion:
 69+  819A              ;			Row FFfff   Column CCCCC
 70+  819A              ;			HL=%010110FF fffCCCCC
 71+  819A              ;-----------------------------------------------------------------------------------------
 72+  819A              CRtoATTR:
 73+  819A 78           			LD A,B						; %___FFfff
 74+  819B 0F           			RRCA						; %f000FFff
 75+  819C 0F           			RRCA						; %ff000FFf
 76+  819D 0F           			RRCA						; %fff000FF
 77+  819E 6F           			LD L,A
 78+  819F E6 03        			AND 3						; %000000FF	value of FF can be only 00,01,10
 79+  81A1 F6 58        			OR #58						; %010110FF value will be #58, #59 or #5A
 80+  81A3 67           			LD H,A
 81+  81A4
 82+  81A4 7D           			LD A,L						; %fff000FF
 83+  81A5 E6 E0        			AND #E0						; %fff00000
 84+  81A7 B1           			OR C						; %fffCCCCC
 85+  81A8 6F           			LD L,A
 86+  81A9
 87+  81A9 22 F1 81                 LD (SCR_ATTR_PTR),HL		; Update Variable
 88+  81AC C9                       RET
 89+  81AD              ; ----------------------------------------------------------------------------------------
 90+  81AD
 91+  81AD
 92+  81AD
 93+  81AD              ; ----------------------------------------------------------------------------------------
 94+  81AD              ; PRINTCHNUM - Prints Char Number N (stored in A)
 95+  81AD              ;-----------------------------------------------------------------------------------------
 96+  81AD              PRINTCHNUM:	;SUB 32						; Adjust Ascii to charset
 97+  81AD 26 00        			LD H,0						; Multiply value by 8 to get to right Char in Charset
 98+  81AF 6F           			LD L,A
 99+  81B0 29           			ADD HL,HL
100+  81B1 29           			ADD HL,HL
101+  81B2 29           			ADD HL,HL
102+  81B3 11 F4 80     			LD DE, CHARSET-(8*32)		; Optimize in compile time (instead of sub 32)
103+  81B6 19           			ADD HL,DE
104+  81B7 EB           			EX  DE,HL					;Value in DE
105+  81B8              			; Continues to printchar below
106+  81B8              ; ----------------------------------------------------------------------------------------
107+  81B8
108+  81B8
109+  81B8              ; ----------------------------------------------------------------------------------------
110+  81B8              ; PRINTCHAR - Prints Char  (DE points to the char. Uses HL as last Cur Pointer)
111+  81B8              ; ----------------------------------------------------------------------------------------
112+  81B8              PRINTCHAR:
113+  81B8 06 08        			LD B,8						; 8 Lines per char
114+  81BA 2A EF 81                 LD HL, (SCR_CUR_PTR)		; Load Cursor Pointer y,x
115+  81BD
116+  81BD 1A           BYTEPCHAR:	LD A,(DE)					; Get Char to be printed, first line
117+  81BE 77           			LD (HL),A					; Move to Printing location
118+  81BF 24                       INC H						; inc H so next line in char (ZX Spectrum Screen RAM)
119+  81C0 13                       INC DE 						; next line to be printed
120+  81C1 10 FA                    DJNZ BYTEPCHAR				; Repeat 8 lines
121+  81C3 3A F3 81                 LD A,(PRINT_ATTR) 			; Load Attributes to print char with
122+  81C6 2A F1 81                 LD HL, (SCR_ATTR_PTR)
123+  81C9 77                       LD (HL),A
124+  81CA 21 F1 81                 LD HL, SCR_ATTR_PTR			; Get pointer to ATTR
125+  81CD 34                       INC (HL)					; Move Attribute cursor to next char
126+  81CE 21 EF 81     			LD HL, SCR_CUR_PTR
127+  81D1 34           			INC (HL)					; update Cursor pointer to next position
128+  81D2 C9                       RET
129+  81D3              ; ----------------------------------------------------------------------------------------
130+  81D3
131+  81D3
132+  81D3
133+  81D3              ; ----------------------------------------------------------------------------------------
134+  81D3              ; INK2PAPER - moves ink of attribute stored in (PRINT_ATTR) to paper and sets ink to 0
135+  81D3              ; 				Sets bright 1 and flash 0
136+  81D3              ; ----------------------------------------------------------------------------------------
137+  81D3 3A F3 81     INK2PAPER:	LD A, (PRINT_ATTR)		    ; Get storedAttribute
138+  81D6 E6 07                    AND 7						; get Attr INK in A
139+  81D8 07           			RLCA
140+  81D9 07           			RLCA
141+  81DA 07           			RLCA						; move Ink to Paper
142+  81DB F6 40        			OR 64						; ink 0 bright 1
143+  81DD 32 F3 81     			LD (PRINT_ATTR),A		    ; Get storedAttribute
144+  81E0 C9           			RET
145+  81E1              ; ----------------------------------------------------------------------------------------
146+  81E1
147+  81E1
148+  81E1
149+  81E1
150+  81E1 21 00 40     CLEARSCR:	LD HL,$4000					; Erases screen by writing 0 to all pixels and attributes
151+  81E4 11 01 40     			LD DE,$4001
152+  81E7 01 FF 1A     			LD BC,6911
153+  81EA 36 00        			LD (HL),0
154+  81EC ED B0        			LDIR
155+  81EE C9           			RET
156+  81EF
157+  81EF
158+  81EF              SCR_CUR_PTR
158+  81EF 00 00          	db $00, $00				; Cursor Pointer in Screen (2 bytes) (HL)
159+  81F1 00 00        SCR_ATTR_PTR: 	db $00, $00				; Attr Pointer in Screen (2 bytes) (HL)
160+  81F3 00           PRINT_ATTR:		db $00					; Attribute used by printchar routine (1 byte)
161+  81F4
162+  81F4              CHARSET: incbin "charset.bin"			; Charset used
163+  84F4
# file closed: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\printat.asm
 14   84F4
 15   84F4
 16   84F4 CD 04 80                 CALL Bienvenida
 17   84F7              ;-------------------------------------------------------------------------------------------------
 18   84F7 18 FE        fin:        JR fin          ; bucle infinito
 19   84F9
# file closed: C:\Users\Usuario\OneDrive\University\UFV\25_26\Arquitectura y Organizacion de Computadores\3_en_raya\mannin.asm
