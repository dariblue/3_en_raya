# file opened: /Users/d4r1/Documents/UFV/2º/Arqui/3_en_raya/mannin.asm
  1   0000                      DEVICE ZXSPECTRUM48
  2   0000              	    SLDOPT COMMENT WPMEM, LOGPOINT, ASSETION
  3   0000                      ORG $8000               ; Programa ubicado a partir de $8000 = 32768
  4   8000
  5   8000 F3           inicio:         DI              ; Deshabilitar interrupciones
  6   8001 31 00 00                     LD SP,0         ; Establecer el puntero de pila en la parte alta de la memoria
  7   8004
  8   8004              ;-------------------------------------------------------------------------------------------------
  9   8004              ;Código del estudiante
 10   8004
 11   8004                  INCLUDE "bienvenida.asm"  ; Incluir el código de bienvenida
# file opened: /Users/d4r1/Documents/UFV/2º/Arqui/3_en_raya/bienvenida.asm
  1+  8004              ; Rutina de bienvenida para el juego Conecta 4
  2+  8004              ; Se incluye desde el programa principal
  3+  8004              Bienvenida:
  4+  8004 3E 00            LD A, 0
  5+  8006 D3 FE            OUT ($FE),A     ; Poner el borde de la pantalla negro
  6+  8008 CD 57 81         CALL CLEARSCR   ; Borrar pantalla
  7+  800B
  8+  800B 3E 82            LD A,2+$80      ; Letra roja, fondo negro, parpadeante
  9+  800D 06 01            LD B,1          ; Coordenadas para pintar el título
 10+  800F 0E 04            LD C,4
 11+  8011 DD 21 9D 80      LD IX,Titulo    ; Dirección del título
 12+  8015 CD E6 80         CALL PRINTAT    ; Imprime el título
 13+  8018
 14+  8018 3E 01            LD A,1          ; Letra azul, fondo negro
 15+  801A 06 0A            LD B,10         ; Coordenadas para pintar el mensaje
 16+  801C 0E 01            LD C,1
 17+  801E DD 21 B5 80      LD IX,Mensaje   ; Dirección del mensaje
 18+  8022 CD E6 80         CALL PRINTAT    ; Imprime el mensaje
 19+  8025
 20+  8025 06 0A            LD B,10         ; Buscamos la dirección del atributo de coordenadas 10,30
 21+  8027 0E 1E            LD C,30         ; Para poner el cursor
 22+  8029 CD 5A 80         CALL Coor_Atrib ; Esta rutina devuelve en HL la dirección del atributo
 23+  802C 3E 81            LD A,1+$80      ; Azul parpadeante
 24+  802E 77               LD (HL),A       ; Pongo el atributo
 25+  802F
 26+  802F CD 77 80         CALL Teclado    ; Leo el teclado hasta que pulsen S o N
 27+  8032
 28+  8032 3E 01            LD A,1          ; Eco de la tecla pulsada
 29+  8034 06 0A            LD B,10
 30+  8036 0E 1E            LD C,30
 31+  8038 DD 21 E4 80      LD IX,Caracter
 32+  803C CD E6 80         CALL PRINTAT
 33+  803F
 34+  803F 3E 07            LD A,7          ; Letra azul, fondo negro
 35+  8041 06 12            LD B,18         ; Coordenadas para pintar el mensaje
 36+  8043 0E 01            LD C,1
 37+  8045 DD 21 D3 80      LD IX,Respuesta   ; Dirección del mensaje
 38+  8049 CD E6 80         CALL PRINTAT    ; Imprime el mensaje
 39+  804C 3E 04            LD A,4
 40+  804E 06 12            LD B,18
 41+  8050 0E 11            LD C,17
 42+  8052 DD 21 E4 80      LD IX,Caracter
 43+  8056 CD E6 80         CALL PRINTAT
 44+  8059
 45+  8059 C9               RET             ; Retornar al programa principal
 46+  805A
 47+  805A              Coor_Atrib:
 48+  805A                                      ; Rutina que recibe en B,C las coordenadas de la pantalla (fila, columna)
 49+  805A                                      ; y devuelve en HL la dirección del atributo correspondiente
 50+  805A F5               PUSH AF             ; Guardamos A en el stack
 51+  805B C5               PUSH BC             ; Guardamos BC en el stack
 52+  805C 60               LD H,b              ; Los bits 4,5 de B deben ser los bits 0,1 de H
 53+  805D CB 3C            SRL H
 53+  805F CB 3C          SRL H
 53+  8061 CB 3C          SRL H
 54+  8063 78               LD A,B              ; Los bits 0,1,2 de B deben ser los bits 5,6,7 de L
 55+  8064 CB 27            SLA A
 55+  8066 CB 27          SLA A
 55+  8068 CB 27          SLA A
 55+  806A CB 27          SLA A
 55+  806C CB 27          SLA a
 56+  806E B1               OR c                ; Y C son los bits 0-4 de L
 57+  806F 6F               LD L,A
 58+  8070 01 00 58         LD BC, $5800        ; Le sumamos la dirección de comienzo de los atributos
 59+  8073 09               ADD HL,BC
 60+  8074 C1               POP BC              ; Restauramos los valores del stack
 61+  8075 F1               POP AF
 62+  8076 C9               RET
 63+  8077
 64+  8077              Teclado:                ; Rutina para leer del teclado 'S' o 'N'
 65+  8077 C5               PUSH BC             ; BC al stack para preservar su valor
 66+  8078              T_N:
 67+  8078 01 FE 7F         LD BC,$7FFE         ; Escanear línea B,N,M,SYMB,Space
 68+  807B ED 78            IN A,(C)
 69+  807D CB 5F            BIT 3,A
 70+  807F 20 04            JR NZ,T_S           ; Han pulsado N
 71+  8081 3E 4E            LD A,'N'
 72+  8083 18 0B            JR T_F
 73+  8085              T_S:
 74+  8085 01 FE FD         LD BC,$FDFE         ; Escanear línea G,F,D,S,A
 75+  8088 ED 78            IN A,(C)
 76+  808A CB 4F            BIT 1,A
 77+  808C 20 EA            JR NZ,T_N           ; No han pulsado 'S'
 78+  808E 3E 53            LD A,'S'
 79+  8090              T_F:
 80+  8090 32 E4 80         LD (Caracter),A     ; Guardo 'S' o 'N' en la Variable Caracter
 81+  8093              Soltar_Tecla:           ; Rutina de espera hasta que se suelta la tecla
 82+  8093 ED 78            IN A,(C)            ; Leer del puerto que se ha definido en Lee_Tecla
 83+  8095 E6 1F            AND $1F
 84+  8097 FE 1F            CP $1F              ; Comprobar que no hay tecla pulsada
 85+  8099 20 F8            JR NZ,Soltar_Tecla  ; esperar hasta que no haya tecla pulsada
 86+  809B C1               POP BC              ; Recuperamos el valor de BC
 87+  809C C9               RET
 88+  809D
 89+  809D 42 69 65 6E  Titulo:    db "Bienvenido al Conecta 4",0    ; Título
 89+  80A1 76 65 6E 69
 89+  80A5 64 6F 20 61
 89+  80A9 6C 20 43 6F
 89+  80AD 6E 65 63 74
 89+  80B1 61 20 34 00
 90+  80B5 45 6D 70 65  Mensaje:   db "Empezamos una partida (S/N)? ",0   ; Mensaje inicial
 90+  80B9 7A 61 6D 6F
 90+  80BD 73 20 75 6E
 90+  80C1 61 20 70 61
 90+  80C5 72 74 69 64
 90+  80C9 61 20 28 53
 90+  80CD 2F 4E 29 3F
 90+  80D1 20 00
 91+  80D3 48 61 73 20  Respuesta: db "Has contestado: ",0      ; Mensaje con la respuesta
 91+  80D7 63 6F 6E 74
 91+  80DB 65 73 74 61
 91+  80DF 64 6F 3A 20
 91+  80E3 00
 92+  80E4 00 00        Caracter:   db 0,0              ; Mensaje del carácter para imprimir
 93+  80E6
 94+  80E6                  INCLUDE printat.asm         ; Incluir el código de PRINTAT
# file opened: /Users/d4r1/Documents/UFV/2º/Arqui/3_en_raya/printat.asm
  1++ 80E6              ; -------------------------------
  2++ 80E6              ; ZX Spectrum Text print library
  3++ 80E6              ; Daniel León - AOC - UFV 2020
  4++ 80E6              ; -------------------------------
  5++ 80E6
  6++ 80E6
  7++ 80E6              ; ----------------------------------------------------------------------------------------
  8++ 80E6              ; PRINTAT - Print a string in a position and attributes as per registers:
  9++ 80E6              ;		IN	A	: Bit 7=1 For Flash / Bit 6=1 For Brigh / Bit 5,4,3 for Paper / Bit 2,1,0 for Ink
 10++ 80E6              ;		IN	B	: Row 0..23
 11++ 80E6              ;		IN	C	: Column 0..31
 12++ 80E6              ;		IN	IX	: Address of text (Text must end in a 0)
 13++ 80E6              ; ----------------------------------------------------------------------------------------
 14++ 80E6 CD F5 80     PRINTAT:	CALL PREP_PRT				; Update Attribute var &Screen & Attributes pointers
 15++ 80E9              ; ----------------------------------------------------------------------------------------
 16++ 80E9              ;		VVV Do not move PRINTSTR below as PRINTAT continues into PRINTSTR routine
 17++ 80E9              ; ----------------------------------------------------------------------------------------
 18++ 80E9              ; PRINTSTR - Prints String - IX Points to the String start
 19++ 80E9              ; ----------------------------------------------------------------------------------------
 20++ 80E9 DD 7E 00     PRINTSTR:   LD A,(IX)					; A Contains first char to print
 21++ 80EC B7           			OR A						; check for end of string (0)
 22++ 80ED C8           			RET Z						; Finish printing if 0
 23++ 80EE CD 23 81     			CALL PRINTCHNUM
 24++ 80F1 DD 23        			INC IX						; Move to next char in string
 25++ 80F3 18 F4        			JR PRINTSTR					; Start over printing sequence
 26++ 80F5              ; ----------------------------------------------------------------------------------------
 27++ 80F5
 28++ 80F5
 29++ 80F5              ;-----------------------------------------------------------------------------------------
 30++ 80F5              ; PREP_PRT - Updates Print_Attr, SCR & ATTR Vars
 31++ 80F5              ;-----------------------------------------------------------------------------------------
 32++ 80F5 32 69 81     PREP_PRT:	LD (PRINT_ATTR),A			; Set Attribute
 33++ 80F8 CD FE 80     PREP_PRT_2:	CALL CRtoSCREEN
 34++ 80FB C3 10 81     			JP CRtoATTR
 35++ 80FE              ;-----------------------------------------------------------------------------------------
 36++ 80FE
 37++ 80FE              ;-----------------------------------------------------------------------------------------
 38++ 80FE              ; CRtoSCREEN - Converts a scr char coord into a SCREEN Address   b,c = y,x positions
 39++ 80FE              ;	IN  - B=Row, C=Column
 40++ 80FE              ;	OUT - HL=Address in screen also stored in (SCR_CUR_PTR)
 41++ 80FE              ;	Conversion:
 42++ 80FE              ;			Row FFfff   Column CCCCC
 43++ 80FE              ;			HL=%010FF000 fffCCCCC
 44++ 80FE              ;-----------------------------------------------------------------------------------------
 45++ 80FE              CRtoSCREEN:
 46++ 80FE 78           			LD A,B						; %___FFfff
 47++ 80FF F6 40        			OR #40						; %010FFfff
 48++ 8101 E6 F8        			AND #F8						; %010FF000
 49++ 8103 67           			LD H,A
 50++ 8104
 51++ 8104 78           			LD A,B						; %___FFfff
 52++ 8105 E6 07        			AND #7						; %00000fff
 53++ 8107 0F           			RRCA						; %f00000ff
 54++ 8108 0F           			RRCA						; %ff00000f
 55++ 8109 0F           			RRCA						; %fff00000
 56++ 810A B1           			OR C						; %fffCCCCC
 57++ 810B 6F           			LD L,A
 58++ 810C 22 65 81                 LD (SCR_CUR_PTR),HL			; Update Variable
 59++ 810F C9                       RET
 60++ 8110              ; ----------------------------------------------------------------------------------------
 61++ 8110
 62++ 8110
 63++ 8110
 64++ 8110              ;-----------------------------------------------------------------------------------------
 65++ 8110              ; CRtoATTR - Converts a screen char coord  into a ATTR Address  b,c = y,x positions
 66++ 8110              ;	IN  - B=Row, C=Column
 67++ 8110              ;	OUT - HL=Address in screen also stored in (SCR_ATTR_PTR)
 68++ 8110              ;	Conversion:
 69++ 8110              ;			Row FFfff   Column CCCCC
 70++ 8110              ;			HL=%010110FF fffCCCCC
 71++ 8110              ;-----------------------------------------------------------------------------------------
 72++ 8110              CRtoATTR:
 73++ 8110 78           			LD A,B						; %___FFfff
 74++ 8111 0F           			RRCA						; %f000FFff
 75++ 8112 0F           			RRCA						; %ff000FFf
 76++ 8113 0F           			RRCA						; %fff000FF
 77++ 8114 6F           			LD L,A
 78++ 8115 E6 03        			AND 3						; %000000FF	value of FF can be only 00,01,10
 79++ 8117 F6 58        			OR #58						; %010110FF value will be #58, #59 or #5A
 80++ 8119 67           			LD H,A
 81++ 811A
 82++ 811A 7D           			LD A,L						; %fff000FF
 83++ 811B E6 E0        			AND #E0						; %fff00000
 84++ 811D B1           			OR C						; %fffCCCCC
 85++ 811E 6F           			LD L,A
 86++ 811F
 87++ 811F 22 67 81                 LD (SCR_ATTR_PTR),HL		; Update Variable
 88++ 8122 C9                       RET
 89++ 8123              ; ----------------------------------------------------------------------------------------
 90++ 8123
 91++ 8123
 92++ 8123
 93++ 8123              ; ----------------------------------------------------------------------------------------
 94++ 8123              ; PRINTCHNUM - Prints Char Number N (stored in A)
 95++ 8123              ;-----------------------------------------------------------------------------------------
 96++ 8123              PRINTCHNUM:	;SUB 32						; Adjust Ascii to charset
 97++ 8123 26 00        			LD H,0						; Multiply value by 8 to get to right Char in Charset
 98++ 8125 6F           			LD L,A
 99++ 8126 29           			ADD HL,HL
100++ 8127 29           			ADD HL,HL
101++ 8128 29           			ADD HL,HL
102++ 8129 11 6A 80     			LD DE, CHARSET-(8*32)		; Optimize in compile time (instead of sub 32)
103++ 812C 19           			ADD HL,DE
104++ 812D EB           			EX  DE,HL					;Value in DE
105++ 812E              			; Continues to printchar below
106++ 812E              ; ----------------------------------------------------------------------------------------
107++ 812E
108++ 812E
109++ 812E              ; ----------------------------------------------------------------------------------------
110++ 812E              ; PRINTCHAR - Prints Char  (DE points to the char. Uses HL as last Cur Pointer)
111++ 812E              ; ----------------------------------------------------------------------------------------
112++ 812E              PRINTCHAR:
113++ 812E 06 08        			LD B,8						; 8 Lines per char
114++ 8130 2A 65 81                 LD HL, (SCR_CUR_PTR)		; Load Cursor Pointer y,x
115++ 8133
116++ 8133 1A           BYTEPCHAR:	LD A,(DE)					; Get Char to be printed, first line
117++ 8134 77           			LD (HL),A					; Move to Printing location
118++ 8135 24                       INC H						; inc H so next line in char (ZX Spectrum Screen RAM)
119++ 8136 13                       INC DE 						; next line to be printed
120++ 8137 10 FA                    DJNZ BYTEPCHAR				; Repeat 8 lines
121++ 8139 3A 69 81                 LD A,(PRINT_ATTR) 			; Load Attributes to print char with
122++ 813C 2A 67 81                 LD HL, (SCR_ATTR_PTR)
123++ 813F 77                       LD (HL),A
124++ 8140 21 67 81                 LD HL, SCR_ATTR_PTR			; Get pointer to ATTR
125++ 8143 34                       INC (HL)					; Move Attribute cursor to next char
126++ 8144 21 65 81     			LD HL, SCR_CUR_PTR
127++ 8147 34           			INC (HL)					; update Cursor pointer to next position
128++ 8148 C9                       RET
129++ 8149              ; ----------------------------------------------------------------------------------------
130++ 8149
131++ 8149
132++ 8149
133++ 8149              ; ----------------------------------------------------------------------------------------
134++ 8149              ; INK2PAPER - moves ink of attribute stored in (PRINT_ATTR) to paper and sets ink to 0
135++ 8149              ; 				Sets bright 1 and flash 0
136++ 8149              ; ----------------------------------------------------------------------------------------
137++ 8149 3A 69 81     INK2PAPER:	LD A, (PRINT_ATTR)		    ; Get storedAttribute
138++ 814C E6 07                    AND 7						; get Attr INK in A
139++ 814E 07           			RLCA
140++ 814F 07           			RLCA
141++ 8150 07           			RLCA						; move Ink to Paper
142++ 8151 F6 40        			OR 64						; ink 0 bright 1
143++ 8153 32 69 81     			LD (PRINT_ATTR),A		    ; Get storedAttribute
144++ 8156 C9           			RET
145++ 8157              ; ----------------------------------------------------------------------------------------
146++ 8157
147++ 8157
148++ 8157
149++ 8157
150++ 8157 21 00 40     CLEARSCR:	LD HL,$4000					; Erases screen by writing 0 to all pixels and attributes
151++ 815A 11 01 40     			LD DE,$4001
152++ 815D 01 FF 1A     			LD BC,6911
153++ 8160 36 00        			LD (HL),0
154++ 8162 ED B0        			LDIR
155++ 8164 C9           			RET
156++ 8165
157++ 8165
158++ 8165              SCR_CUR_PTR
158++ 8165 00 00          	db $00, $00				; Cursor Pointer in Screen (2 bytes) (HL)
159++ 8167 00 00        SCR_ATTR_PTR: 	db $00, $00				; Attr Pointer in Screen (2 bytes) (HL)
160++ 8169 00           PRINT_ATTR:		db $00					; Attribute used by printchar routine (1 byte)
161++ 816A
162++ 816A              CHARSET: incbin "charset.bin"			; Charset used
163++ 846A
# file closed: /Users/d4r1/Documents/UFV/2º/Arqui/3_en_raya/printat.asm
# file closed: /Users/d4r1/Documents/UFV/2º/Arqui/3_en_raya/bienvenida.asm
 12   846A
 13   846A CD 04 80         CALL Bienvenida  ; Llamar a la rutina de bienvenida
 14   846D              ;-------------------------------------------------------------------------------------------------
 15   846D 18 FE        fin:            JR fin          ; bucle infinito
 16   846F
# file closed: /Users/d4r1/Documents/UFV/2º/Arqui/3_en_raya/mannin.asm
